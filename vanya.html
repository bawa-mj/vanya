<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vanya - Voice of Wisdom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        serif: ['Cormorant Garamond', 'serif'],
                    },
                    colors: {
                        mystic: {
                            950: '#05070A', // Ultra Dark
                            900: '#0B0F19', // Main Bg
                            800: '#111827', // Cards
                            700: '#1F2937', // Borders
                            600: '#374151', // Lighter Borders
                            400: '#9CA3AF', // Muted Text
                            200: '#E5E7EB', // Main Text
                            100: '#F3F4F6', // Highlights
                        },
                        gold: {
                            400: '#FCD34D',
                            500: '#F59E0B',
                            600: '#D97706',
                            900: '#451a03',
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 30px -5px rgba(245, 158, 11, 0.15)',
                        'card': '0 10px 40px -10px rgba(0, 0, 0, 0.5)',
                        'neon': '0 0 15px rgba(245, 158, 11, 0.5), 0 0 30px rgba(245, 158, 11, 0.3)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ripple': 'ripple 1.5s linear infinite',
                    },
                    keyframes: {
                        ripple: {
                            '0%': { boxShadow: '0 0 0 0 rgba(245, 158, 11, 0.3)' },
                            '100%': { boxShadow: '0 0 0 20px rgba(245, 158, 11, 0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0B0F19;
            color: #E5E7EB;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* Custom Scrollbar */
        .chat-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .chat-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-scroll::-webkit-scrollbar-thumb {
            background-color: #374151;
            border-radius: 20px;
        }

        .fade-in-up {
            animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
            transform: translateY(15px);
        }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .mic-button-active {
            background-color: #F59E0B;
            color: white;
            animation: ripple 1.5s linear infinite;
        }
    </style>
</head>
<body class="font-sans antialiased overflow-hidden selection:bg-gold-500/30 selection:text-gold-400">

    <!-- Header -->
    <header class="bg-mystic-900/80 backdrop-blur-md border-b border-mystic-800 flex-none z-20 transition-all duration-500">
        <div class="max-w-3xl mx-auto px-4 h-16 flex items-center justify-between">
            <!-- Left Side: Logo & Name -->
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-mystic-800 flex items-center justify-center border border-mystic-700 shadow-glow relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gold-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <i class="fas fa-spa text-gold-400 text-xs sm:text-sm relative z-10"></i>
                </div>
                <div>
                    <h1 class="font-serif text-lg sm:text-xl font-bold text-mystic-100 tracking-wide">Vanya</h1>
                    <p class="text-[8px] sm:text-[9px] uppercase tracking-[0.2em] text-mystic-500 font-medium">Voice of Wisdom</p>
                </div>
            </div>
            
            <!-- Right Side: Language Toggle with Full Text -->
            <button id="langToggle" class="group flex items-center gap-1.5 sm:gap-2 px-3 py-1.5 sm:px-4 rounded-full border border-mystic-700 bg-mystic-800 text-mystic-400 hover:text-gold-400 hover:border-gold-500/30 hover:bg-mystic-700/50 transition-all duration-300">
                <i class="fas fa-globe text-[10px] sm:text-xs group-hover:rotate-180 transition-transform duration-500"></i>
                <span id="langLabel" class="text-[10px] sm:text-xs font-serif font-medium tracking-wide">Hindi</span>
            </button>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chatContainer" class="flex-grow overflow-y-auto chat-scroll p-3 sm:p-4 scroll-smooth bg-gradient-to-b from-mystic-900 via-mystic-900 to-mystic-950">
        <!-- Reduced bottom padding since footer is now smaller -->
        <div class="max-w-3xl mx-auto flex flex-col gap-6 pb-32"> 
            
            <!-- Welcome Message -->
            <div class="flex justify-center mt-6 sm:mt-8 mb-4 fade-in-up">
                <div class="text-center space-y-3 px-4">
                    <div class="inline-block p-3 sm:p-4 rounded-full bg-mystic-800 border border-mystic-700 shadow-glow mb-2">
                        <i class="fas fa-om text-2xl sm:text-3xl text-gold-500"></i>
                    </div>
                    <p id="welcomeMsg" class="text-mystic-300 font-serif text-lg sm:text-xl italic tracking-wide">
                        "Speak your heart, and the ancient wisdom shall guide you."
                    </p>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="messagesList" class="flex flex-col gap-6 sm:gap-8">
                <!-- Dynamic messages go here -->
            </div>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden justify-start fade-in-up">
                <div class="bg-mystic-800 border border-mystic-700 rounded-2xl rounded-tl-none px-4 py-3 sm:px-5 sm:py-4 shadow-none inline-flex items-center gap-2">
                    <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-gold-500 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-gold-500 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-gold-500 rounded-full typing-dot"></div>
                </div>
            </div>

        </div>
    </main>

    <!-- Voice Control Footer -->
    <!-- Centered, Minimalist Footer -->
    <footer class="fixed bottom-0 left-0 right-0 bg-mystic-950/85 backdrop-blur-xl border-t border-mystic-800/50 py-4 px-4 z-30 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.8)]">
        <div class="max-w-3xl mx-auto flex items-center justify-center">
            
            <!-- Main Action Button (Centered & Responsive) -->
            <div class="relative flex-shrink-0">
                <!-- Ripple Effect Container -->
                <div id="micRipple" class="absolute inset-0 rounded-full bg-gold-500/20 opacity-0 transition-opacity duration-300 blur-md"></div>
                
                <button id="micBtn" class="w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-mystic-800 border border-mystic-600 shadow-card flex items-center justify-center text-gold-400 text-lg sm:text-xl transition-all duration-300 hover:scale-105 active:scale-95 group relative z-10 overflow-hidden hover:border-gold-500/50">
                    <span class="relative z-10">
                        <i id="micIcon" class="fas fa-microphone"></i>
                    </span>
                    <!-- Hover Glow -->
                    <div class="absolute inset-0 bg-gold-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </button>
            </div>
            
        </div>
    </footer>

    <!-- Error Modal/Toast -->
    <div id="errorToast" class="fixed top-20 left-1/2 transform -translate-x-1/2 -translate-y-20 opacity-0 transition-all duration-500 z-50 pointer-events-none w-11/12 max-w-sm">
        <div class="bg-red-900/90 backdrop-blur border border-red-800 text-red-200 px-6 py-3 rounded-full shadow-lg flex items-center gap-3 justify-center">
            <i class="fas fa-exclamation-circle text-sm flex-shrink-0"></i>
            <span id="errorMsg" class="font-medium text-xs">Error message here</span>
        </div>
    </div>

    <!-- No Speech Support Modal -->
    <div id="noSpeechModal" class="fixed inset-0 bg-mystic-950/90 z-50 hidden flex items-center justify-center p-6">
        <div class="bg-mystic-800 border border-mystic-700 p-6 rounded-2xl text-center max-w-sm shadow-2xl">
            <i class="fas fa-microphone-slash text-4xl text-mystic-500 mb-4"></i>
            <h3 class="text-xl font-serif text-gold-400 mb-2">Voice Not Supported</h3>
            <p class="text-mystic-400 text-sm mb-6">Your browser doesn't support the speech features required for this experience. Please try Chrome, Edge, or Safari.</p>
        </div>
    </div>

    <script>
        // --- Configuration ---
        let currentLang = 'en'; 
        let recognition = null;
        let isRecording = false;
        let isSpeaking = false;
        let appState = 'idle'; // idle, listening, processing, speaking
        // IMPORTANT: Replace with your actual Gemini API Key
        const apiKey = "AIzaSyCrwz16nGReMEXO2Sah1RJGAX3MsLCEn-w"; 

        // --- DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const messagesList = document.getElementById('messagesList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const micBtn = document.getElementById('micBtn');
        const micIcon = document.getElementById('micIcon');
        // Removed statusText DOM element reference
        const langToggle = document.getElementById('langToggle');
        const langLabel = document.getElementById('langLabel'); 
        const welcomeMsg = document.getElementById('welcomeMsg');
        const errorToast = document.getElementById('errorToast');
        const errorMsg = document.getElementById('errorMsg');
        const micRipple = document.getElementById('micRipple');
        const noSpeechModal = document.getElementById('noSpeechModal');

        // --- Translations ---
        const texts = {
            en: {
                label: "Hindi", // Text to switch TO
                welcome: "\"Speak your heart, and the ancient wisdom shall guide you.\"",
                error: "Unable to connect to the divine source."
            },
            hi: {
                label: "English", // Text to switch TO
                welcome: "\"अपने दिल की बात कहें, प्राचीन ज्ञान आपका मार्गदर्शन करेगा।\"",
                error: "संपर्क करने में असमर्थ।"
            }
        };

        // --- UI Functions ---
        function scrollToBottom() {
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function setStatus(state) {
            appState = state;
            
            switch(state) {
                case 'listening':
                    micBtn.classList.add('mic-button-active', 'scale-110');
                    micIcon.classList.remove('fa-microphone');
                    micIcon.classList.add('fa-stop');
                    micRipple.classList.add('opacity-100');
                    break;
                case 'processing':
                    resetMicVisuals();
                    // Optional: Add subtle pulse to indicate thinking if needed, but ripple reset is fine
                    micBtn.classList.add('border-gold-500/50');
                    break;
                case 'speaking':
                    // Show speaker icon on main button while speaking
                    micBtn.classList.add('border-gold-500', 'text-gold-400');
                    micIcon.classList.remove('fa-microphone');
                    micIcon.classList.add('fa-volume-high', 'animate-pulse');
                    break;
                default: // idle
                    resetMicVisuals();
            }
        }

        function resetMicVisuals() {
            micBtn.classList.remove('mic-button-active', 'scale-110', 'border-gold-500', 'text-gold-400', 'border-gold-500/50');
            micIcon.className = 'fas fa-microphone'; // Reset icon
            micRipple.classList.remove('opacity-100');
        }

        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = "flex justify-end fade-in-up px-2";
            div.innerHTML = `
                <div class="bg-gold-600 text-white rounded-2xl rounded-tr-sm px-5 py-3 sm:px-6 sm:py-4 max-w-[85%] shadow-lg text-base sm:text-lg leading-relaxed font-light border border-gold-500/50 break-words">
                    ${text}
                </div>
            `;
            messagesList.appendChild(div);
            scrollToBottom();
        }

        function addBotMessage(data) {
            const div = document.createElement('div');
            div.className = "flex justify-start fade-in-up px-2";
            
            div.innerHTML = `
                <div class="bg-mystic-800/95 backdrop-blur-md border border-mystic-700 rounded-2xl rounded-tl-sm px-6 py-5 sm:px-8 sm:py-6 max-w-[95%] sm:max-w-[85%] shadow-card relative group hover:border-mystic-600 transition-colors">
                    <div class="absolute -top-3 -left-3 w-8 h-8 rounded-full bg-mystic-900 border border-mystic-600 flex items-center justify-center shadow-lg z-10">
                        <i class="fas fa-spa text-gold-500 text-xs"></i>
                    </div>
                    
                    <div class="text-center mb-4 sm:mb-6 pb-4 sm:pb-6 border-b border-mystic-700/50 relative">
                        <i class="fas fa-quote-left absolute top-0 left-0 text-mystic-700/30 text-2xl sm:text-3xl -z-10"></i>
                        <p class="font-serif text-xl sm:text-2xl text-gold-100 font-medium mb-2 sm:mb-3 leading-relaxed tracking-wide">
                            "${data.shloka}"
                        </p>
                        <p class="text-gold-400 font-serif italic text-sm sm:text-base opacity-90">
                            ${data.meaning}
                        </p>
                    </div>

                    <div class="prose prose-invert prose-p:font-light prose-p:text-mystic-200 prose-p:leading-7 sm:prose-p:leading-8 prose-p:text-base sm:prose-p:text-lg max-w-none">
                        ${data.guidance}
                    </div>
                </div>
            `;
            
            messagesList.appendChild(div);
            scrollToBottom();
        }

        // --- Speech Recognition ---
        function initSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    isRecording = true;
                    setStatus('listening');
                };

                recognition.onend = () => {
                    isRecording = false;
                    setTimeout(() => {
                        // Only reset to idle if we aren't in a processing state
                        // This prevents flickering if the API call is in progress
                        if (appState === 'listening') {
                            setStatus('idle');
                        }
                    }, 500);
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if(transcript.trim()) {
                        handleVoiceInput(transcript);
                    }
                };

                recognition.onerror = (event) => {
                    console.error("Speech Error:", event.error);
                    setStatus('idle');
                    showError("Listening failed. Try again.");
                };
            } else {
                noSpeechModal.classList.remove('hidden');
            }
        }

        // --- Core Logic ---
        function updateLanguage() {
            langLabel.innerText = texts[currentLang].label;
            welcomeMsg.innerText = texts[currentLang].welcome;
            if(isSpeaking) window.speechSynthesis.cancel();
            setStatus('idle');
            
            if (recognition) recognition.lang = currentLang === 'hi' ? 'hi-IN' : 'en-US';
        }

        langToggle.addEventListener('click', () => {
            currentLang = currentLang === 'en' ? 'hi' : 'en';
            updateLanguage();
        });

        micBtn.addEventListener('click', () => {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                setStatus('idle');
            } else if (isRecording) {
                recognition.stop();
            } else {
                if(!recognition) initSpeech();
                recognition.start();
            }
        });

        async function handleVoiceInput(text) {
            setStatus('processing');
            addUserMessage(text);
            loadingIndicator.classList.remove('hidden');
            scrollToBottom();
            
            // Domain Specific System Prompt
            const systemPrompt = `
                You are Vanya, a dedicated spiritual guide. Your sole purpose is to provide wisdom from Hindu Mythology, specifically the **Ramayana** and the **Bhagavad Gita**, regarding life problems, emotional struggles, and spiritual growth.
                
                CRITICAL INSTRUCTION:
                If the user asks about anything UNRELATED to spirituality, mental health, or life guidance (e.g., coding, math, general knowledge, news), you MUST politely refuse. Say: "I am Vanya, here only to guide your soul. Please ask me about your heart's burdens."

                If the query is relevant:
                1. Analyze the user's situation.
                2. Select a relevant **Sanskrit Shloka** (from Gita/Puranas) OR a **Chaupai** (from Ramcharitmanas).
                3. Provide its meaning.
                4. Give compassionate, practical advice based on the teachings of Lord Rama (Dharma/Duty) or Lord Krishna (Karma/Wisdom).

                Return JSON ONLY:
                {
                    "shloka": "Sanskrit Shloka or Chaupai text",
                    "meaning": "Meaning in ${currentLang === 'hi' ? 'Hindi' : 'English'}",
                    "guidance": "Advice in ${currentLang === 'hi' ? 'Hindi' : 'English'}."
                }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `User Said: "${text}"` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                
                let rawText = data.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const result = JSON.parse(rawText);

                loadingIndicator.classList.add('hidden');
                addBotMessage(result);
                
                speakResponse(result.shloka, result.meaning, result.guidance);

            } catch (error) {
                console.error(error);
                loadingIndicator.classList.add('hidden');
                setStatus('idle');
                showError(texts[currentLang].error);
            }
        }

        function speakResponse(shloka, meaning, guidance) {
            if ('speechSynthesis' in window) {
                setStatus('speaking');
                
                const fullText = `${shloka}. ${meaning}. ${guidance}`;
                const utterance = new SpeechSynthesisUtterance(fullText);
                utterance.lang = currentLang === 'hi' ? 'hi-IN' : 'en-US';
                utterance.rate = 0.9; 

                const voices = window.speechSynthesis.getVoices();
                let preferredVoice = null;

                const voiceLang = currentLang === 'hi' ? 'hi' : 'en';

                // Strategy: Look for "Hindi" language AND "Female" keywords
                preferredVoice = voices.find(voice => 
                    voice.lang.includes(voiceLang) && 
                    (voice.name.includes('Google') || 
                     voice.name.includes('Swara') || 
                     voice.name.includes('Lekha') || 
                     voice.name.includes('Female')) 
                );

                if (!preferredVoice) {
                    preferredVoice = voices.find(voice => 
                        voice.lang.includes(voiceLang) && (voice.name.includes('India'))
                    );
                }

                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }

                utterance.onend = () => {
                    isSpeaking = false;
                    setStatus('idle');
                };
                
                utterance.onerror = () => {
                    isSpeaking = false;
                    setStatus('idle');
                }

                isSpeaking = true;
                window.speechSynthesis.speak(utterance);
            }
        }

        function showError(msg) {
            errorMsg.innerText = msg;
            errorToast.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => {
                errorToast.classList.add('-translate-y-20', 'opacity-0');
            }, 4000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSpeech();
            window.speechSynthesis.onvoiceschanged = () => {};
        });

    </script>
</body>
</html>